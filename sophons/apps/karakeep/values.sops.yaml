#
# IMPORTANT NOTE
#
# This chart inherits from the bjw-s library chart. You can check the default values/options here:
# https://github.com/bjw-s/helm-charts/tree/main/charts/library/common
#
applicationProtocol: https
applicationHost: holding.sophons.cloud
# enc!
applicationSecretKey: ENC[AES256_GCM,data:fY/OzWkxBPp0VU/Lz47V+U04LAKoj0UrRnd7I/KLhEe8jjddF/4m8wPlrQkiuT2e,iv:c++SSFv5rEfgKMnIFqpoAHUm9iMRXhV4yJGGkkZGAEY=,tag:CIINI0r6qsT+oHYvOr8NgQ==,type:str]
# enc!
meilisearchMasterKey: ENC[AES256_GCM,data:D7KgM7tFWXDOB2HY+mDrE7xpc/pB1Kirdt690y6j,iv:Xj6IgPFB+bD8Ln7M8hoXqPVSCIEEcLKJB4cVrXyUIXw=,tag:KsoW44I915eEB0Ao8diEZA==,type:str]
ingress:
  karakeep:
    enabled: false
controllers:
  karakeep:
    type: deployment
    strategy: Recreate
    statefulset:
      volumeClaimTemplates: []
    containers:
      karakeep:
        image:
          tag: 0.28.0
        # Next.js is a plague :(
        resources:
          requests:
            cpu: 150m
            memory: 300Mi
          limits:
            memory: 756Mi
        envFrom:
          - secretRef:
              name: '{{ .Release.Name }}'
          - secretRef:
              name: '{{ .Release.Name }}-meilesearch'
          - secretRef:
              name: hoarder-access-key
          - secretRef:
              name: karakeep-oauth
        env:
          DISABLE_SIGNUPS: "true"
          DB_WAL_MODE: "true"
          ASSET_STORE_S3_ENDPOINT: s3.eu-central-003.backblazeb2.com
          ASSET_STORE_S3_REGION: eu-central-003
          ASSET_STORE_S3_BUCKET: sophons-karakeep
          ASSET_STORE_S3_FORCE_PATH_STYLE: "true"
          OAUTH_WELLKNOWN_URL: https://auth.sophons.cloud/.well-known/openid-configuration
          OAUTH_CLIENT_ID: sphns_q1F-KFdfxuwpzFejpdac311zzc65t0eiT.X1Vu3mE5
          OAUTH_PROVIDER_NAME: Authelia
          OAUTH_ALLOW_DANGEROUS_EMAIL_ACCOUNT_LINKING: "true"
          # 15s
          OAUTH_TIMEOUT: "15000"
          OPENAI_API_KEY: clankerstudio
          # lmstudio on kaos
          OPENAI_BASE_URL: http://100.64.0.26:11433/v1
          INFERENCE_TEXT_MODEL: openai/gpt-oss-20b
          INFERENCE_IMAGE_MODEL: qwen/qwen3-vl-8b
          EMBEDDING_TEXT_MODEL: qwen/qwen3-embedding-4b
          INFERENCE_CONTEXT_LENGTH: "49152"
          INFERENCE_MAX_OUTPUT_TOKENS: "16384"
          INFERENCE_ENABLE_AUTO_TAGGING: "true"
          INFERENCE_ENABLE_AUTO_SUMMARIZATION: "true"
          # 2.5 minutes
          INFERENCE_JOB_TIMEOUT_SEC: "150"
          CRAWLER_FULL_PAGE_ARCHIVE: "true"
          # 3 minutes
          CRAWLER_JOB_TIMEOUT_SEC: "300"
          CRAWLER_SCREENSHOT_TIMEOUT_SEC: "60"
      litestream-replicate:
        image:
          repository: docker.io/litestream/litestream
          tag: 0.5.2
        args:
          - replicate
          - -config=/etc/litestream/litestream.yaml
        envFrom:
          - secretRef:
              name: litestream-access-key
        ports:
          - name: metrics
            containerPort: 9090
      tailscale:
        image:
          repository: ghcr.io/tailscale/tailscale
          tag: v1.90.6
        envFrom:
          - secretRef:
              name: tailscale-ephemeral-auth
        env:
          - name: TS_EXTRA_ARGS
            value: $(TS_BASE_ARGS)
          - name: TS_TAILSCALED_EXTRA_ARGS
            value: $(TSD_BASE_ARGS)
          - name: TS_HOSTNAME
            value: karakeep
          - name: TS_USERSPACE
            value: "false"
        ports:
          - name: ts-metrics
            containerPort: 9002
        securityContext:
          privileged: true
          capabilities:
            drop:
              - ALL
          seccompProfile:
            type: RuntimeDefault
        liveness:
          enabled: true
          spec:
            initialDelaySeconds: 10
            httpGet:
              path: /healthz
              port: 9002
        readiness:
          enabled: true
          spec:
            initialDelaySeconds: 10
            httpGet:
              path: /healthz
              port: 9002
    initContainers:
      litestream-restore-db:
        image:
          repository: docker.io/litestream/litestream
          tag: 0.5.2
        args:
          - restore
          - -config=/etc/litestream/litestream.yaml
          - -if-db-not-exists
          - -if-replica-exists
          - /data/db.db
        envFrom:
          - secretRef:
              name: litestream-access-key
      litestream-restore-queue:
        image:
          repository: docker.io/litestream/litestream
          tag: 0.5.2
        args:
          - restore
          - -config=/etc/litestream/litestream.yaml
          - -if-db-not-exists
          - -if-replica-exists
          - /data/queue.db
        envFrom:
          - secretRef:
              name: litestream-access-key
  chrome:
    pod:
      nodeSelector:
        topology.kubernetes.io/region: ng
    containers:
      chrome:
        args:
          # FIXME: CHROME SANDBOX
          # - --no-sandbox
          - --remote-debugging-address=0.0.0.0
          - --remote-debugging-port=9222
          - --headless
          - --hide-scrollbars
          - --disable-gpu
          - --disable-dev-shm-usage
        securityContext:
          runAsNonRootUser: true
          readOnlyRootFilesystem: true
          allowPrivilegeEscalation: false
          capabilities:
            add:
              - SYS_ADMIN
          seccompProfile:
            type: RuntimeDefault
            # # TODO: WHY WON'T THIS SHIT WORK
            # seccompProfile:
            #   type: Localhost
            #   localhostProfile: profiles/chrome.json
        resources:
          requests:
            cpu: 100m
          limits:
            cpu: null
persistence:
  data:
    type: emptyDir
    advancedMounts:
      karakeep:
        karakeep:
          - path: /data
        litestream-replicate:
          - path: /data
        litestream-restore-db:
          - path: /data
        litestream-restore-queue:
          - path: /data
  # tailscale-state:
  #   type: emptyDir
  #   medium: Memory
  #   advancedMounts:
  #     karakeep:
  #       tailscale:
  #         - path: /var/lib/tailscale
  chrome-tmp:
    type: emptyDir
    advancedMounts:
      chrome:
        chrome:
          - path: /tmp
  chrome-home:
    type: emptyDir
    advancedMounts:
      chrome:
        chrome:
          - path: /home/chrome
  # chrome-cache:
  #   type: emptyDir
  #   advancedMounts:
  #     chrome:
  #       chrome:
  #         - path: /var/cache
  litestream:
    type: configMap
    name: litestream
    advancedMounts:
      karakeep:
        litestream-replicate:
          - path: /etc/litestream
        litestream-restore-db:
          - path: /etc/litestream
        litestream-restore-queue:
          - path: /etc/litestream
meilisearch:
  resources:
    requests:
      cpu: 50m
      memory: 128Mi
    limits:
      cpu: 250m
      memory: 512Mi
  persistence:
    existingClaim: karakeep-meilisearch
sops:
  age:
    - recipient: ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAII7yyj/sVuDdc6kGEeipVtC0EBaeACTFWHZ9MH77XsFq vrtx@kaos
      enc: |
        -----BEGIN AGE ENCRYPTED FILE-----
        YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IHNzaC1lZDI1NTE5IDNEQlRBdyBQbi9n
        WW1reXpVT0dkeVlPZlkxdjFteXlpeElEbmxtY2ZXNFdHSHdTdjFzCjkyM2xzY3l1
        RG5XbVF1b0w2ZkpJOXBMb1NJYWowUEVkWk5jbXV0OE5KM1kKLS0tIHFLQi9CZEZ6
        Z1ppNmVYc2xvdUViTlFPRlh3TDhRSjBwMURReDlsTkV4TU0K8ggMlKD6km/E7L6J
        tDPYkMnX7uhdju0cByBJdxZRAQ7OBMghCCqS/R4ZcS2tE/pk9QwyJbLn4S4i6ZLm
        /qvaDw==
        -----END AGE ENCRYPTED FILE-----
    - recipient: age1kum4z0unkunza7kxt4ma7v8k38ggvtjhx6wntnjt8clt6xpyu3eqsw435t
      enc: |
        -----BEGIN AGE ENCRYPTED FILE-----
        YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSB5K0U2cmRXb28xZmJlY0M0
        WXZBWS9UMlBWSE45SXZ5dGMxLzJuRTYybmx3CithS0FvSTNqSGxRSnZ0dzVPbE1x
        MmVCQTE0WG5Ld0RWNnpXUGxQU29va28KLS0tIEpCejVvbXVxbjhONTJrTUs2c3hZ
        TGlrQ0dxUVk1YzVuMUZNR3JoNlc3azQK3pC18KAp9H7PrLiZxd4+ldx2UqN8idik
        pB7g69BnSFVbQQNIy/A9xXpkmW68IRWjf8URaBQU8dSic8L/ay0xGg==
        -----END AGE ENCRYPTED FILE-----
  lastmodified: "2025-11-20T00:40:56Z"
  mac: ENC[AES256_GCM,data:yuvBGKc2q1z15NeGd/L0BIN840Ugqi9K25YCKnH9HVv4qau97Kfw30bVOoE8gOutC0oa+F46FXaFziJITzg5rrspAH7G+fcRlO7HGBAGjiDOqN4jL/pk2cfLqjZXhG3uKI/Er6tspIUjYj0zqeRJRXqYs8F2SZnKwJVyAtJXHt4=,iv:i2LI+AKGD8LfvSPg+l10Nex1kEUtaVZvjZV3UwXtU7I=,tag:SDlUo+c7GT2J6Gf2akg28w==,type:str]
  encrypted_comment_regex: enc!
  version: 3.11.0
