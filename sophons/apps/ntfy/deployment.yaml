# yaml-language-server: $schema=https://github.com/yannh/kubernetes-json-schema/raw/refs/heads/master/v1.34.1/deployment-apps-v1.json
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ntfy
  namespace: ntfy
  labels:
    app.kubernetes.io/name: ntfy
spec:
  strategy:
    type: Recreate
  replicas: 1

  selector:
    matchLabels:
      app.kubernetes.io/name: ntfy
  template:
    metadata:
      labels:
        app.kubernetes.io/name: ntfy
    spec:
      tolerations:
        - key: prime.sophons.cloud
          operator: Exists
        - key: "orunmila.sophons.cloud/ase-orun"
          operator: Exists

      affinity:
        nodeAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 10
              preference:
                matchExpressions:
                  - key: topology.kubernetes.io/zone
                    operator: NotIn
                    # avoid running inside me house if possible
                    values: [ng-east-1, ng-east-2, ng-middle-east]

      securityContext:
        fsGroup: 1000
        runAsUser: 1000
        runAsGroup: 1000
        runAsNonRoot: true
        seccompProfile:
          type: RuntimeDefault

      containers:
        - name: ntfy
          image: binwiederhier/ntfy
          args: ["serve", "--config=/etc/ntfy/server.yaml"]

          ports:
            - containerPort: 80
              name: http

          volumeMounts:
            - name: config
              mountPath: "/etc/ntfy"
              readOnly: true
            - name: ntfy
              mountPath: "/var/lib/ntfy"

          env:
            - name: GOMEMLIMIT
              value: 120MiB

          envFrom:
            - secretRef:
                name: ntfy

          resources:
            requests:
              cpu: 50m
              memory: 64Mi
            limits:
              memory: 128Mi

          securityContext:
            readOnlyRootFilesystem: true
            allowPrivilegeEscalation: false
            capabilities:
              drop: [ALL]

        - name: litestream-legacy-replicate
          image: docker.io/litestream/litestream:0.3.13
          args: ["replicate", "-config=/etc/litestream/litestream-legacy.yaml"]
          envFrom:
            - secretRef:
                name: litestream-access-key
          env:
            - name: GOMEMLIMIT
              value: 120MiB

          ports:
            - name: ls-metrics
              containerPort: 9090

          volumeMounts:
            - name: ntfy
              mountPath: "/var/lib/ntfy"
            - name: litestream
              mountPath: "/etc/litestream"
              readOnly: true

          securityContext:
            readOnlyRootFilesystem: true
            allowPrivilegeEscalation: false
            capabilities:
              drop: [ALL]

          resources:
            requests:
              cpu: 25m
              memory: 64Mi
            limits:
              memory: 128Mi

      initContainers:
        - name: litestream-legacy-restore-cache
          image: docker.io/litestream/litestream:0.3.13
          args:
            - restore
            - -config=/etc/litestream/litestream-legacy.yaml
            - /var/lib/ntfy/cache.db

          envFrom:
            - secretRef:
                name: litestream-access-key
          env:
            - name: GOMEMLIMIT
              value: 120MiB
            - name: LITESTREAM_LOGGING_LEVEL
              value: debug

          volumeMounts:
            - name: ntfy
              mountPath: "/var/lib/ntfy"
            - name: litestream
              mountPath: "/etc/litestream"
              readOnly: true

          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop: [ALL]

          resources:
            requests:
              cpu: 25m
              memory: 128Mi
            limits:
              memory: 128Mi

        - name: litestream-legacy-restore-webpush
          image: docker.io/litestream/litestream:0.3.13
          args:
            - restore
            - -config=/etc/litestream/litestream-legacy.yaml
            - /var/lib/ntfy/webpush.db

          envFrom:
            - secretRef:
                name: litestream-access-key
          env:
            - name: GOMEMLIMIT
              value: 120MiB
            - name: LITESTREAM_LOGGING_LEVEL
              value: debug

          volumeMounts:
            - name: ntfy
              mountPath: "/var/lib/ntfy"
            - name: litestream
              mountPath: "/etc/litestream"
              readOnly: true
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop: [ALL]

      volumes:
        - name: ntfy
          emptyDir:
            sizeLimit: 512Mi
        - name: config
          secret:
            secretName: ntfy-config
        - name: litestream
          configMap:
            name: litestream
