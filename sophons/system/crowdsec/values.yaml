container_runtime: containerd

tls:
  enabled: true
  agent:
    tlsClientAuth: true
    reflector:
      namespaces: [logging-system]

config:
  config.yaml.local: |
    db_config:
      flush:
        agents_autodelete:
          cert: 60m # This is TLS client authentication
          login_password: 60m # This includes the auto registration token as well
        ## Flush both login types if the machine has not logged in for 60 minutes or more

    api:
      server:
        auto_registration:
          enabled: true
          token: "${REGISTRATION_TOKEN}" # /!\ Do not modify this variable (auto-generated and handled by the chart)
          allowed_ranges:
            - "127.0.0.1/32"
            - "192.168.0.0/16"
            - "10.0.0.0/8"
            - "172.16.0.0/12"
            - "10.41.0.0/16"
            - "2001:cafe:41::/56"

secrets:
  externalSecret:
    name: crowdsec

lapi:
  resources:
    requests:
      cpu: 150m
      memory: 128Mi
    limits:
      cpu: null
      memory: 384Mi

  persistentVolume:
    config:
      enabled: false
    data:
      enabled: false
  env:
    - name: ENROLL_KEY
      valueFrom:
        secretKeyRef:
          name: crowdsec
          key: enrollKey
    - name: BOUNCER_KEY_traefik
      valueFrom:
        secretKeyRef:
          name: crowdsec
          key: traefikBouncerKey
    - name: ENROLL_INSTANCE_NAME
      value: "sophons"
    - name: ENROLL_TAGS
      value: "k8s linux"

agent:
  hostVarLog: false
  # isDeployment: true
  # replicas: 1
  # strategy:
  #   type: RollingUpdate

  env:
    - name: GOMEMLIMIT
      value: 128MiB
    - name: COLLECTIONS
      value: "crowdsecurity/traefik crowdsecurity/linux"

  resources:
    requests:
      cpu: 50m
      memory: 32Mi
    limits:
      cpu: null
      memory: 128Mi
  tolerations:
    - key: prime.sophons.cloud
      operator: Exists

  persistentVolume:
    config:
      enabled: false

  # this is ignored for daemonset, but cant use deployment
  # cuz that's broken too :)
  ports:
    - name: syslog-udp
      containerPort: 4242
      protocol: UDP
    - name: http
      containerPort: 6969
      protocol: TCP

  service:
    ports:
      - name: syslog-udp
        protocol: UDP
        port: 4242
        targetPort: 4242
      - name: http
        protocol: TCP
        port: 6969
        targetPort: 6969

  additionalAcquisition:
    - source: syslog
      listen_addr: 0.0.0.0
      listen_port: 4242
      labels:
        type: syslog
    - source: http
      listen_addr: 0.0.0.0:6969
      path: /v1/logs/traefik
      timeout: 30s
      auth_type: mtls
      tls:
        ca_cert: /etc/ssl/crowdsec-agent/ca.crt
        server_key: /etc/ssl/crowdsec-agent/tls.key
        server_cert: /etc/ssl/crowdsec-agent/tls.crt
      labels:
        type: traefik
