# yaml-language-server: $schema=https://kubernetesjsonschema.dev/v1.18.1/deployment.json
apiVersion: apps/v1
kind: Deployment
metadata:
  name: haproxy-sango
  namespace: traefik
  labels:
    app.kubernetes.io/name: traefik
    app.kubernetes.io/component: haproxy-sango
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app.kubernetes.io/name: traefik
      app.kubernetes.io/component: haproxy-sango
  template:
    metadata:
      labels:
        app.kubernetes.io/name: traefik
        app.kubernetes.io/component: haproxy-sango
      annotations:
        external-dns.alpha.kubernetes.io/hostname: |
          traefik-sango.sophons.cloud, traefik-sango-star-theta.sophons.cloud
        # enc!
        external-dns.alpha.kubernetes.io/target: ENC[AES256_GCM,data:q+OF+4LcwHzjqiFmAeU=,iv:fdakIB2qC7ATgU4V6R07RrNnun7tClyFMdaUTQ8Ht08=,tag:VrGwJAq9mKdaL5tp1McTHA==,type:str]
    spec:
      tolerations:
        - key: orunmila.sophons.cloud/ase-orun
          operator: Exists
        - key: node.kubernetes.io/memory-pressure
          operator: Exists
      containers:
        - name: proxy
          image: haproxy:3.2.8-alpine3.22
          # override the entrypoint preprending extra args
          # which shouldn't be happening but idk
          command:
            - sh
            - -c
            - haproxy -db -f /etc/haproxy/haproxy.cfg
          volumeMounts:
            - mountPath: /etc/haproxy
              name: haproxy
              readOnly: true
          ports:
            - containerPort: 22
              name: ssh
              hostPort: 22
            - containerPort: 80
              name: http
              hostPort: 80
            - containerPort: 443
              name: https
              hostPort: 443
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            runAsNonRoot: true
            runAsUser: 1000
            runAsGroup: 1000
            capabilities:
              drop:
                - ALL
              add:
                - NET_BIND_SERVICE
          resources:
            requests:
              cpu: 50m
              memory: 32Mi
            limits:
              memory: 100Mi
      volumes:
        - name: haproxy
          configMap:
            name: haproxy
      nodeSelector:
        kubernetes.io/hostname: sophons-oduduwa
sops:
  age:
    - recipient: ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAII7yyj/sVuDdc6kGEeipVtC0EBaeACTFWHZ9MH77XsFq vrtx@kaos
      enc: |
        -----BEGIN AGE ENCRYPTED FILE-----
        YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IHNzaC1lZDI1NTE5IDNEQlRBdyBEak4r
        UVVPUFhUdEJCcm9yWUl5dmR6K29SQXQ4dXZ1NDdKOEVOUUtvb1djCjIwU3Q2Wjk4
        MjFQbnZDc09Fc25NUTh4QnpTNDFad0FjVEpmMGQ2YjJaOVkKLS0tIDAzNDN1ck4w
        ZGlBYnFmUlZWNDNpWVF1enFyL1JjVUVJTDVnSnRBWHVNakEKgmWgSjYoKaXyZ+SW
        KA8035pfWq0dMXM7QT1Sg7f3Vn4urwTz2J4vm3tZkExozSGmnK1pTgz/31RSPV2T
        n6qrjQ==
        -----END AGE ENCRYPTED FILE-----
    - recipient: age1kum4z0unkunza7kxt4ma7v8k38ggvtjhx6wntnjt8clt6xpyu3eqsw435t
      enc: |
        -----BEGIN AGE ENCRYPTED FILE-----
        YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBudWhyY1lxOWxYblR0NEtW
        MWpIN0dacVpscVhmSi9MOXkvWUZqTExqUW5nCjU3RGcyS0kzNlZjWU14VEZsTGFq
        djgrWWJXOW9EMVcxWmo1ZW1mWEk2WkkKLS0tIGZwOTkxS1VJMUI1WVZwUFI1NUFU
        dmlNYkR6ZndYY0NGTStyRGhxa0xLUzAKoYNHqggbdiTCwRbu7ps0FkWUgcJl/n+7
        WEeSlt2ob5BT0ydpmScgpIbKbE1vM4QqwNaLhiKGGRlbbSiO2ODb3A==
        -----END AGE ENCRYPTED FILE-----
  lastmodified: "2025-11-18T18:44:41Z"
  mac: ENC[AES256_GCM,data:Cdkb0KOfOmbtqzjV73NTB4cdsgxuvDMGdt6+3yxD+uz88i24BUlQIcuz/s8/gPv5ihoCBQaVZwmUNXz1rhSqvmvgnDSGCkLyJraDqc3d/240vr0fcidhykNSrwN18S/7tWBBkgiqUidc2JwGJS8B5S7ALscka7gD0BlW78t3kQU=,iv:L+JkkxT8c4mYxcQzpQbEdl85TYu0jdXOcFQ4BQNvflw=,tag:Rafe4dMXNJWjcKFTTY5UAQ==,type:str]
  encrypted_comment_regex: enc!
  version: 3.11.0
